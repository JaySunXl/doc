---
title: Spring:事务
date: 2018-10-25
tags:
- Java
- Spring
---
<details>
<summary>点击展开目录</summary>
<!-- TOC -->

- [使用](#使用)
- [事务的传播属性](#事务的传播属性)
    - [requires_new](#requires_new)
    - [never](#never)
    - [nested](#nested)
- [原理](#原理)
    - [@Transactional注解](#transactional注解)
    - [注意点](#注意点)
- [参考](#参考)

<!-- /TOC -->
</details>

## 使用

Spring配置文件中关于事务配置总是由三个组成部分, 分别是DataSource、TransactionManager和代理机制这三部分

## 事务的传播属性

事务传播行为: 多个事务方法相互调用时, 事务如何在这些方法间传播

事务属性通常由事务的传播行为, 事务的隔离级别, 事务的超时值和事务只读标志组成

解决的是业务层之间的方法调用

| No   | 行为                      | 说明                                                         |
| :--- | :------------------------ | :----------------------------------------------------------- |
| 1    | propagation.required      | 当前有事务则加入, 否则新建                                   |
| 2    | propagation.supports      | 使用当前事务, 无则以非事务方法执行                           |
| 3    | propagation.mandatory     | 使用当前事务, 无则抛异常                                     |
| 4    | propagation.requires_new  | 新建事务, 若存在当前事务, 则将其挂起                         |
| 5    | propagation.not_supported | 非事务方式执行, 若存在当前事务, 则将其挂起                   |
| 6    | propagation.never         | 非事务方式执行, 若存在当前事务, 则抛出异常                   |
| 7    | propagation.nested        | 当前存在事务, 则在嵌套事务内执行, 无则类似于`propagation_required` |

> 7: 嵌套事务: 当a执行之后, 就会在这个位置设置一个保存点.如果b没有问题则执行通过<br/>如果b出现异常, 运行客户根据需求回滚(选择回滚到保存点或者是最初始状态)

### requires_new

内层事务可以独立回滚, 不影响外层事务

### never

只读操作时可以使用这个

`@Transactional(propagation = Propagation.NEVER, readOnly = true)`

### nested



## 原理
Spring在TransactionDefinition接口中定义以上属性
TransactionDefinition

### @Transactional注解

`@Transactional` 省略了原生JDBC中的事务开启, 结束的内容, 全部交给了spring, 其原理是为类生成了代理.



### 注意点

在同一个类中一个普通方法调用另一个有事务的方法, 事务是不会起作用的

`@Transactional`可能失效的总结:
* 加于private方法, 无效
* 加于未加入接口的public方法, 再通过普通接口方法调用, 无效
* 加于接口方法后, 被本类普通接口方法直接调用, 无效
* 加于接口方法, 无论下面调用的是private或public方法, 都有效
* 加于接口方法后, 被本类普通接口方法通过接口调用, 有效
* 加于接口方法后, 被它类的接口方法调用, 有效
* 加于接口方法后, 被它类的私有方法调用后, 有效

> Transactional是否生效, 仅取决于是否加载于接口方法, 并且是否通过接口方法调用(而不是本类调用)

## 参考

0. [Spring事务传播行为详解](https://segmentfault.com/a/1190000013341344)
1. [透彻的掌握 Spring 中@transactional 的使用](https://www.ibm.com/developerworks/cn/java/j-master-spring-transactional-use/index.html)
https://segmentfault.com/a/1190000015794446
https://segmentfault.com/q/1010000018526749

[![](https://static.segmentfault.com/v-5b1df2a7/global/img/creativecommons-cc.svg)](https://creativecommons.org/licenses/by-nc-nd/4.0/)
