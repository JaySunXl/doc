---
title: 定时任务
date: 2019-01-29
tags:
- 
---


# Scheduled


```Java
@EnableScheduling

@Scheduled(fixedRate = 30 * 1000)
每30秒执行一次

@Scheduled(fixedDelay = 5 * 1000)
执行结束后延迟5秒后再次执行

@Scheduled(initialDelay=1 * 1000, fixedRate=5 * 1000)
等待1秒后开始执行第一次, 之后每5秒执行一次

@Scheduled(cron = "0 50 16 * * ?")

```



cron表达式有至少6个(也可能7个)有空格分隔的时间元素
从左往右依次代表

1. Seconds Minutes Hours DayofMonth Month DayofWeek Year
2. Seconds Minutes Hours DayofMonth Month DayofWeek

`*`: 匹配任意值
`,`: 指定执行
`-`: 范围执行
`/`: 间隔执行

Usage:

`0 0-5 14 * * ?` 在每天下午2时到下午2:05内, 每1分钟执行次
`0 0/5 14,18 * * ?` 每天14, 18时0分开始, 每隔5分钟一次



## 并行

定时任务在同一线程中串行执行, 在多定时任务时可能出现不执行的情况
原因:

```Java
if (this.taskScheduler == null) {
    this.localExecutor = Executors.newSingleThreadScheduledExecutor();
    this.taskScheduler = new ConcurrentTaskScheduler(this.localExecutor);
}
```

解决1:
```Java
@Configuration
public class SchedulingConfig implements SchedulingConfigurer {
    @Override
    public void configureTasks(ScheduledTaskRegistrar taskRegistrar) {
        taskRegistrar.setScheduler(Executors.newScheduledThreadPool(5));
    }
}
```

解决2
```Java
@Component
@EnableScheduling
@EnableAsync
public class Task1 {
    @Async
    @Scheduled(cron = "0 * * * * ?")
    public void execute() {
    }

    @Async
    @Scheduled(cron = "10 * * * * ?")
    public void execute1() {
    }
}
```

类上添加`@EnableAsync`注解, 任务方法上添加`@Async`注解

解决3(经验证无效):
```Java
@Component
@Configuration
@EnableScheduling
public class SchedulingConfig {
    @Scheduled(cron = "0 0/10 * * * ?")
    public void method() {
        ......;
    }
}
```


# Tips

同一任务前一周期没有执行完,过去接下来n次任务开始时间, 那么后n次的任务会推迟并累积, 会像赶时间一样将这n次任务执行掉.

# Usage

```Java
private static int i = 1;

@Scheduled(fixedRate = 3 * 1000)
public void method() throws Exception {
    System.out.println("time: " + System.currentTimeMillis());
    if (i == 1) {
        Thread.sleep(21 * 1000);
        i = 0;
    }
    method1();
}

private static int aa = 1;
public void method1() {
    aa++;
    System.out.println(Thread.currentThread().getName() + " :" + aa);
}
```

# Quartz


# 参考

https://segmentfault.com/a/1190000013077817

[![](https://static.segmentfault.com/v-5b1df2a7/global/img/creativecommons-cc.svg)](https://creativecommons.org/licenses/by-nc-nd/4.0/)
