<details>
<summary>点击展开目录</summary>
<!-- TOC -->

- [表级别](#表级别)
- [字段级别](#字段级别)
- [参考](#参考)

<!-- /TOC -->
</details>




org.apache.hadoop.hive.ql.tools.LineageInfo


```Java
public static void main(String[] args)
        throws IOException, ParseException, SemanticException {
    String query = args[0];
    LineageInfo lep = new LineageInfo();
    lep.getLineageInfo(query);
    for (String tab : lep.getInputTableList()) {
      System.out.println("InputTable=" + tab);
    }
    for (String tab : lep.getOutputTableList()) {
      System.out.println("OutputTable=" + tab);
    }
  }
```

## 表级别

关键类: `org.apache.hadoop.hive.ql.tools.LineageInfo`

命令行调用方式:
```shell
hadoop jar /usr/local/hive/lib/hive-exec-1.1.0-cdh5.9.0.jar org.apache.hadoop.hive.ql.tools.LineageInfo <sql>
# InputTable=dict_cityinfo
# InputTable=dict_zoneinfo
# OutputTable=cxy7_dw.tmp_zone_info
```

java调用方式:
```Java
import org.apache.hadoop.hive.ql.tools.LineageInfo;
public class Demo {
    public static void main(String[] args) throws Exception {
        String sql = "";
        LineageInfo.main(new String[]{sql});
    }
}
```

## 字段级别

关键类: `org.apache.hadoop.hive.ql.hooks.LineageLogger`


<details>
<summary>配置</summary>

hive-site.xml
```xml
<property>
    <name>hive.exec.post.hooks</name>
    <value>org.apache.hadoop.hive.ql.hooks.LineageLogger</value>
</property>
```

hive-log4j.properties
```conf
# 默认日志输出在/tmp/${user.home}/hive.log
log4j.logger.org.apache.hadoop.hive.ql.hooks.LineageLogger=INFO
```
</details>

试验:
```sql
create table t_student(id int, name string);
create table t_score(id int, student_id int, name string, score int);
create table t_summary(id int, student_name string, xueke_name string, score int);

insert into table t_summary
select
    R2.id,
    r1.name as xingming,
    concat(r1.name, '.', r2.name) as xueke,
    r2.score as fenshu
from t_student r1
left join t_score r2
    on r1.id = r2.student_id
where
    R1.id = 1
;
```

[分析结果]()

vertices: 顶点. 代表参与DAG的节点元素, vertexType有`COLUMN`和`TABLE`两个值
edges: 边. 代表DAG的流向, sources -> targets, edgeType有`PROJECTION(投影)`和`PREDICATE(谓语)`两个值

## 参考

1. [1](http://cxy7.com/articles/2018/05/26/1527300004975.html)

[![](https://static.segmentfault.com/v-5b1df2a7/global/img/creativecommons-cc.svg)](https://creativecommons.org/licenses/by-nc-nd/4.0/)
